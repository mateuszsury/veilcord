---
phase: 02-signaling-infrastructure--presence
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - frontend/src/stores/network.ts
  - frontend/src/stores/contacts.ts
  - frontend/src/components/layout/Sidebar.tsx
  - frontend/src/components/settings/SettingsPanel.tsx
  - frontend/src/components/settings/NetworkSection.tsx
  - frontend/src/components/layout/StatusSelector.tsx
autonomous: true

must_haves:
  truths:
    - "User sees connection status indicator in UI"
    - "User sees contacts with colored online status dots"
    - "User can change their status via dropdown"
    - "User can configure signaling server URL in settings"
    - "Presence updates appear in real-time"
  artifacts:
    - path: "frontend/src/stores/network.ts"
      provides: "Network state management"
      exports: ["useNetworkStore"]
    - path: "frontend/src/components/settings/NetworkSection.tsx"
      provides: "Network settings UI"
      contains: "signaling server"
    - path: "frontend/src/components/layout/StatusSelector.tsx"
      provides: "User status dropdown"
      contains: "UserStatus"
  key_links:
    - from: "frontend/src/stores/network.ts"
      to: "frontend/src/lib/pywebview.ts"
      via: "api.call() for network methods"
      pattern: "get_connection_state|set_user_status"
    - from: "frontend/src/components/layout/Sidebar.tsx"
      to: "frontend/src/stores/network.ts"
      via: "useNetworkStore hook"
      pattern: "useNetworkStore"
    - from: "frontend/src/stores/contacts.ts"
      to: "discordopus:presence event"
      via: "Event listener updates contact status"
      pattern: "discordopus:presence"
---

<objective>
Build frontend UI for connection status, user status selection, and contact presence display.

Purpose: Users can see and manage their online status and see contacts' online status in real-time.
Output: Network Zustand store, status selector component, presence indicators in sidebar.
</objective>

<execution_context>
@C:\Users\thete\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thete\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-signaling-infrastructure--presence/02-RESEARCH.md
@.planning/phases/02-signaling-infrastructure--presence/02-03-SUMMARY.md

Existing code references:
@frontend/src/stores/contacts.ts - Contacts Zustand store
@frontend/src/stores/ui.ts - UI state store (pattern reference)
@frontend/src/components/layout/Sidebar.tsx - Sidebar with contacts list
@frontend/src/components/settings/SettingsPanel.tsx - Settings panel
@frontend/src/lib/pywebview.ts - API client and types
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create network Zustand store</name>
  <files>
    frontend/src/stores/network.ts
  </files>
  <action>
    Create Zustand store for network state:

    1. **Create frontend/src/stores/network.ts**:
       ```typescript
       import { create } from 'zustand';
       import type { ConnectionState, UserStatus } from '@/lib/pywebview';
       import { api } from '@/lib/pywebview';

       interface NetworkState {
         connectionState: ConnectionState;
         userStatus: UserStatus;
         signalingServer: string;
         isLoading: boolean;
         error: string | null;

         // Actions
         setConnectionState: (state: ConnectionState) => void;
         setUserStatus: (status: UserStatus) => void;
         setSignalingServer: (url: string) => void;
         setLoading: (loading: boolean) => void;
         setError: (error: string | null) => void;

         // Async actions that call API
         loadInitialState: () => Promise<void>;
         updateUserStatus: (status: UserStatus) => Promise<void>;
         updateSignalingServer: (url: string) => Promise<void>;
       }

       export const useNetworkStore = create<NetworkState>((set, get) => ({
         connectionState: 'disconnected',
         userStatus: 'online',
         signalingServer: '',
         isLoading: true,
         error: null,

         setConnectionState: (connectionState) => set({ connectionState }),
         setUserStatus: (userStatus) => set({ userStatus }),
         setSignalingServer: (signalingServer) => set({ signalingServer }),
         setLoading: (isLoading) => set({ isLoading }),
         setError: (error) => set({ error, isLoading: false }),

         loadInitialState: async () => {
           try {
             set({ isLoading: true, error: null });
             const [state, status, server] = await Promise.all([
               api.call((a) => a.get_connection_state()),
               api.call((a) => a.get_user_status()),
               api.call((a) => a.get_signaling_server()),
             ]);
             set({
               connectionState: state,
               userStatus: status,
               signalingServer: server,
               isLoading: false,
             });
           } catch (e) {
             set({ error: String(e), isLoading: false });
           }
         },

         updateUserStatus: async (status) => {
           try {
             await api.call((a) => a.set_user_status(status));
             set({ userStatus: status });
           } catch (e) {
             set({ error: String(e) });
           }
         },

         updateSignalingServer: async (url) => {
           try {
             await api.call((a) => a.set_signaling_server(url));
             set({ signalingServer: url });
           } catch (e) {
             set({ error: String(e) });
           }
         },
       }));

       // Set up event listeners for backend events
       if (typeof window !== 'undefined') {
         window.addEventListener('discordopus:connection', ((e: CustomEvent) => {
           useNetworkStore.getState().setConnectionState(e.detail.state);
         }) as EventListener);
       }
       ```
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit`
    - No TypeScript errors
  </verify>
  <done>
    Network Zustand store tracks connection state and user status
  </done>
</task>

<task type="auto">
  <name>Task 2: Update contacts store with presence event handling</name>
  <files>
    frontend/src/stores/contacts.ts
  </files>
  <action>
    Update contacts store to handle presence updates:

    1. **Update frontend/src/stores/contacts.ts**:
       - Add updateContactStatus action
       - Set up event listener for discordopus:presence event

       ```typescript
       import { create } from 'zustand';
       import type { ContactResponse, UserStatus } from '@/lib/pywebview';

       interface ContactsState {
         contacts: ContactResponse[];
         isLoading: boolean;
         error: string | null;

         setContacts: (contacts: ContactResponse[]) => void;
         addContact: (contact: ContactResponse) => void;
         removeContact: (id: number) => void;
         updateContact: (id: number, updates: Partial<ContactResponse>) => void;
         updateContactStatus: (publicKey: string, status: UserStatus) => void;  // NEW
         setLoading: (loading: boolean) => void;
         setError: (error: string | null) => void;
       }

       export const useContactsStore = create<ContactsState>((set) => ({
         contacts: [],
         isLoading: true,
         error: null,

         setContacts: (contacts) => set({ contacts, isLoading: false, error: null }),

         addContact: (contact) =>
           set((state) => ({
             contacts: [...state.contacts, contact],
           })),

         removeContact: (id) =>
           set((state) => ({
             contacts: state.contacts.filter((c) => c.id !== id),
           })),

         updateContact: (id, updates) =>
           set((state) => ({
             contacts: state.contacts.map((c) =>
               c.id === id ? { ...c, ...updates } : c
             ),
           })),

         // NEW: Update contact online status by public key
         updateContactStatus: (publicKey, status) =>
           set((state) => ({
             contacts: state.contacts.map((c) =>
               c.publicKey.includes(publicKey) ? { ...c, onlineStatus: status } : c
             ),
           })),

         setLoading: (isLoading) => set({ isLoading }),
         setError: (error) => set({ error, isLoading: false }),
       }));

       // Set up event listener for presence updates from backend
       if (typeof window !== 'undefined') {
         window.addEventListener('discordopus:presence', ((e: CustomEvent) => {
           useContactsStore.getState().updateContactStatus(e.detail.publicKey, e.detail.status);
         }) as EventListener);
       }
       ```
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit`
    - No TypeScript errors
  </verify>
  <done>
    Contacts store updates online status on presence events
  </done>
</task>

<task type="auto">
  <name>Task 3: Create status selector and connection indicator components</name>
  <files>
    frontend/src/components/layout/StatusSelector.tsx
    frontend/src/components/layout/ConnectionIndicator.tsx
  </files>
  <action>
    Create UI components for status display and selection:

    1. **Create frontend/src/components/layout/StatusSelector.tsx**:
       - Dropdown to select user status (online/away/busy/invisible)
       - Shows current status with colored dot
       - Calls network store updateUserStatus on change

       ```tsx
       import { useNetworkStore } from '@/stores/network';
       import type { UserStatus } from '@/lib/pywebview';

       const statusColors: Record<UserStatus, string> = {
         online: 'bg-green-500',
         away: 'bg-yellow-500',
         busy: 'bg-red-500',
         invisible: 'bg-gray-500',
         offline: 'bg-gray-700',
         unknown: 'bg-gray-700',
       };

       const statusLabels: Record<UserStatus, string> = {
         online: 'Online',
         away: 'Away',
         busy: 'Do Not Disturb',
         invisible: 'Invisible',
         offline: 'Offline',
         unknown: 'Unknown',
       };

       export function StatusSelector() {
         const { userStatus, updateUserStatus } = useNetworkStore();

         const selectableStatuses: UserStatus[] = ['online', 'away', 'busy', 'invisible'];

         return (
           <div className="relative">
             <select
               value={userStatus}
               onChange={(e) => updateUserStatus(e.target.value as UserStatus)}
               className="appearance-none bg-cosmic-800/50 border border-cosmic-600/30 rounded-lg px-3 py-2 pr-8 text-sm text-cosmic-100 focus:outline-none focus:ring-2 focus:ring-cosmic-500"
             >
               {selectableStatuses.map((status) => (
                 <option key={status} value={status}>
                   {statusLabels[status]}
                 </option>
               ))}
             </select>
             <div className={`absolute right-2 top-1/2 -translate-y-1/2 w-2 h-2 rounded-full ${statusColors[userStatus]}`} />
           </div>
         );
       }
       ```

    2. **Create frontend/src/components/layout/ConnectionIndicator.tsx**:
       - Shows connection state with icon/color
       - Tooltip with details

       ```tsx
       import { useNetworkStore } from '@/stores/network';
       import type { ConnectionState } from '@/lib/pywebview';

       const stateConfig: Record<ConnectionState, { color: string; label: string; icon: string }> = {
         disconnected: { color: 'text-red-500', label: 'Disconnected', icon: '○' },
         connecting: { color: 'text-yellow-500', label: 'Connecting...', icon: '◐' },
         authenticating: { color: 'text-yellow-500', label: 'Authenticating...', icon: '◑' },
         connected: { color: 'text-green-500', label: 'Connected', icon: '●' },
       };

       export function ConnectionIndicator() {
         const { connectionState } = useNetworkStore();
         const config = stateConfig[connectionState];

         return (
           <div
             className={`flex items-center gap-1.5 text-xs ${config.color}`}
             title={config.label}
           >
             <span className="animate-pulse">{config.icon}</span>
             <span className="hidden sm:inline">{config.label}</span>
           </div>
         );
       }
       ```
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit`
    - No TypeScript errors
  </verify>
  <done>
    Status selector and connection indicator components created
  </done>
</task>

<task type="auto">
  <name>Task 4: Update Sidebar with status indicators</name>
  <files>
    frontend/src/components/layout/Sidebar.tsx
  </files>
  <action>
    Update Sidebar to show user status selector and contact online status:

    1. **Update frontend/src/components/layout/Sidebar.tsx**:
       - Import StatusSelector and ConnectionIndicator
       - Add StatusSelector in header area (near user identity display)
       - Add ConnectionIndicator in footer
       - Add online status dot next to each contact in the list

       Key changes:
       - Add status dot next to contact display name:
         ```tsx
         const statusColors: Record<string, string> = {
           online: 'bg-green-500',
           away: 'bg-yellow-500',
           busy: 'bg-red-500',
           invisible: 'bg-gray-500',
           offline: 'bg-gray-700',
           unknown: 'bg-gray-700',
         };

         // In contact list item:
         <div className="flex items-center gap-2">
           <div className={`w-2 h-2 rounded-full ${statusColors[contact.onlineStatus || 'unknown']}`} />
           <span>{contact.displayName}</span>
         </div>
         ```

       - Add StatusSelector and ConnectionIndicator to layout:
         ```tsx
         // In header section
         <StatusSelector />

         // In footer section
         <ConnectionIndicator />
         ```

       - Initialize network store on mount:
         ```tsx
         useEffect(() => {
           useNetworkStore.getState().loadInitialState();
         }, []);
         ```
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit`
    - `cd frontend && npm run build`
    - Verify wiring: `grep -q "import.*StatusSelector" frontend/src/components/layout/Sidebar.tsx && echo "StatusSelector imported" || echo "MISSING StatusSelector import"`
    - Verify wiring: `grep -q "import.*ConnectionIndicator" frontend/src/components/layout/Sidebar.tsx && echo "ConnectionIndicator imported" || echo "MISSING ConnectionIndicator import"`
    - Verify wiring: `grep -q "<StatusSelector" frontend/src/components/layout/Sidebar.tsx && echo "StatusSelector rendered" || echo "MISSING StatusSelector usage"`
    - No build errors
  </verify>
  <done>
    Sidebar shows connection status and contact presence (StatusSelector and ConnectionIndicator integrated)
  </done>
</task>

<task type="auto">
  <name>Task 5: Create network settings section</name>
  <files>
    frontend/src/components/settings/NetworkSection.tsx
    frontend/src/components/settings/SettingsPanel.tsx
  </files>
  <action>
    Create network settings UI for signaling server configuration:

    1. **Create frontend/src/components/settings/NetworkSection.tsx**:
       - Input field for signaling server URL
       - Save button that calls updateSignalingServer
       - Connection status display
       - Test connection button (optional)

       ```tsx
       import { useState, useEffect } from 'react';
       import { useNetworkStore } from '@/stores/network';
       import { ConnectionIndicator } from '@/components/layout/ConnectionIndicator';

       export function NetworkSection() {
         const { signalingServer, updateSignalingServer, connectionState } = useNetworkStore();
         const [serverUrl, setServerUrl] = useState(signalingServer);
         const [isSaving, setIsSaving] = useState(false);

         useEffect(() => {
           setServerUrl(signalingServer);
         }, [signalingServer]);

         const handleSave = async () => {
           if (serverUrl === signalingServer) return;
           setIsSaving(true);
           try {
             await updateSignalingServer(serverUrl);
           } finally {
             setIsSaving(false);
           }
         };

         return (
           <div className="space-y-4">
             <h3 className="text-lg font-semibold text-cosmic-100">Network</h3>

             <div className="space-y-2">
               <label className="block text-sm text-cosmic-300">
                 Signaling Server
               </label>
               <div className="flex gap-2">
                 <input
                   type="url"
                   value={serverUrl}
                   onChange={(e) => setServerUrl(e.target.value)}
                   placeholder="wss://signaling.example.com/ws"
                   className="flex-1 bg-cosmic-800/50 border border-cosmic-600/30 rounded-lg px-3 py-2 text-cosmic-100 placeholder-cosmic-500 focus:outline-none focus:ring-2 focus:ring-cosmic-500"
                 />
                 <button
                   onClick={handleSave}
                   disabled={isSaving || serverUrl === signalingServer}
                   className="px-4 py-2 bg-cosmic-600 hover:bg-cosmic-500 disabled:bg-cosmic-700 disabled:opacity-50 rounded-lg text-white text-sm transition-colors"
                 >
                   {isSaving ? 'Saving...' : 'Save'}
                 </button>
               </div>
               <p className="text-xs text-cosmic-400">
                 The WebSocket server used for signaling and presence. Changes will reconnect.
               </p>
             </div>

             <div className="flex items-center justify-between pt-2 border-t border-cosmic-700/50">
               <span className="text-sm text-cosmic-300">Connection Status</span>
               <ConnectionIndicator />
             </div>
           </div>
         );
       }
       ```

    2. **Update frontend/src/components/settings/SettingsPanel.tsx**:
       - Import and add NetworkSection
       - Place after Identity section (or before Backup)

       Add import:
       ```tsx
       import { NetworkSection } from './NetworkSection';
       ```

       Add section in render:
       ```tsx
       <NetworkSection />
       ```
  </action>
  <verify>
    - `cd frontend && npm run build`
    - No build errors
  </verify>
  <done>
    Network settings section allows server URL configuration
  </done>
</task>

</tasks>

<verification>
1. Frontend builds successfully:
   ```bash
   cd frontend && npm run build
   ```

2. TypeScript compiles without errors:
   ```bash
   cd frontend && npx tsc --noEmit
   ```

3. All new components exist:
   ```bash
   ls frontend/src/stores/network.ts
   ls frontend/src/components/layout/StatusSelector.tsx
   ls frontend/src/components/layout/ConnectionIndicator.tsx
   ls frontend/src/components/settings/NetworkSection.tsx
   ```
</verification>

<success_criteria>
- Network store manages connection state and user status
- Status selector allows changing user status
- Connection indicator shows current state
- Contact list shows online status dots
- Settings panel has network configuration section
- All presence updates appear in real-time via events
</success_criteria>

<output>
After completion, create `.planning/phases/02-signaling-infrastructure--presence/02-04-SUMMARY.md`
</output>
