---
phase: 02-signaling-infrastructure--presence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/network/presence.py
  - src/network/__init__.py
  - src/storage/settings.py
  - src/storage/contacts.py
  - src/storage/db.py
  - src/storage/__init__.py
autonomous: true

must_haves:
  truths:
    - "User status persists across app restarts"
    - "Contacts have online_status field that updates"
    - "Signaling server URL is configurable and persisted"
    - "User can be online, away, busy, invisible, or offline"
  artifacts:
    - path: "src/network/presence.py"
      provides: "Presence state management"
      exports: ["PresenceManager", "UserStatus"]
    - path: "src/storage/settings.py"
      provides: "User settings persistence"
      exports: ["get_setting", "set_setting", "Settings"]
    - path: "src/storage/contacts.py"
      provides: "Contact with online status"
      contains: "online_status"
  key_links:
    - from: "src/network/presence.py"
      to: "src/storage/contacts.py"
      via: "update_contact_online_status()"
      pattern: "update_contact_online_status"
    - from: "src/network/presence.py"
      to: "src/storage/settings.py"
      via: "get_setting/set_setting for user status"
      pattern: "get_setting.*user_status"
---

<objective>
Implement presence state management and settings storage for user status and contact online tracking.

Purpose: Track user's own status and contacts' online/offline state with persistence.
Output: PresenceManager class and settings storage for status persistence.
</objective>

<execution_context>
@C:\Users\thete\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thete\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-signaling-infrastructure--presence/02-RESEARCH.md
@.planning/phases/01-cryptographic-foundation-packaging/01-02-SUMMARY.md

Existing code references:
@src/storage/db.py - SQLCipher database (get_database, init_database)
@src/storage/contacts.py - Contact storage (get_contacts, Contact dataclass)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings storage module</name>
  <files>
    src/storage/settings.py
    src/storage/db.py
    src/storage/__init__.py
  </files>
  <action>
    Create settings storage for user preferences:

    1. **Update src/storage/db.py** - Add settings table to schema:
       - Add to _init_schema():
         ```sql
         CREATE TABLE IF NOT EXISTS settings (
             key TEXT PRIMARY KEY,
             value TEXT NOT NULL,
             updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
         )
         ```
       - This is a key-value store for app settings

    2. **Create src/storage/settings.py**:
       - `Settings` class with known setting keys as constants:
         - USER_STATUS = "user_status" (default: "online")
         - SIGNALING_SERVER_URL = "signaling_server_url" (default: "wss://signaling.discordopus.example/ws")
       - `get_setting(key: str, default: str | None = None) -> str | None`
         - Returns setting value or default if not found
       - `set_setting(key: str, value: str) -> None`
         - INSERT OR REPLACE into settings table
       - `get_all_settings() -> dict[str, str]`
         - Returns all settings as dict
       - `delete_setting(key: str) -> None`
         - Remove a setting

    3. **Update src/storage/__init__.py** - Export settings module:
       - Add exports for Settings, get_setting, set_setting

    Note: Use get_database() from db.py. All settings stored as strings.
  </action>
  <verify>
    - `python -c "from src.storage import get_setting, set_setting; set_setting('test', 'value'); print(get_setting('test'))"`
    - Should print "value"
  </verify>
  <done>
    Settings key-value storage exists with get/set functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Update contacts with online status field</name>
  <files>
    src/storage/contacts.py
    src/storage/db.py
  </files>
  <action>
    Add online status tracking to contacts:

    1. **Update src/storage/db.py** - Add online_status column to contacts table:
       - Modify _init_schema() contacts table:
         ```sql
         online_status TEXT DEFAULT 'unknown'
         ```
       - Add migration for existing databases (ALTER TABLE if column doesn't exist):
         ```python
         # After table creation, check and add column if missing
         try:
             cursor.execute("ALTER TABLE contacts ADD COLUMN online_status TEXT DEFAULT 'unknown'")
         except sqlite3.OperationalError:
             pass  # Column already exists
         ```

    2. **Update src/storage/contacts.py**:
       - Add `online_status: str` field to Contact dataclass (default: "unknown")
       - Update get_contacts() to include online_status in SELECT
       - Update get_contact() to include online_status in SELECT
       - Add `update_contact_online_status(contact_id: int, status: str) -> None`
         - Updates online_status for a contact
       - Add `update_contact_online_status_by_pubkey(public_key_hex: str, status: str) -> None`
         - Updates online_status by matching Ed25519 public key
         - Needed because presence updates come by public key, not contact ID
       - Add `get_contact_by_pubkey(public_key_hex: str) -> Contact | None`
         - Find contact by Ed25519 public key (convert hex to PEM, query)

    Valid online_status values: "online", "away", "busy", "invisible", "offline", "unknown"
  </action>
  <verify>
    - `python -c "from src.storage.contacts import Contact; c = Contact(id=1, ed25519_public_pem='', x25519_public_hex='', display_name='', fingerprint='', verified=False, added_at='', online_status='online'); print(c.online_status)"`
    - Should print "online"
  </verify>
  <done>
    Contacts have online_status field that can be updated
  </done>
</task>

<task type="auto">
  <name>Task 3: Create presence manager</name>
  <files>
    src/network/presence.py
    src/network/__init__.py
  </files>
  <action>
    Create presence state management:

    1. **Create src/network/presence.py**:
       - `UserStatus` enum: ONLINE, AWAY, BUSY, INVISIBLE, OFFLINE
         - Add `.value` property that returns lowercase string ("online", "away", etc.)
       - `PresenceManager` class:
         - `__init__(on_status_change: Callable[[str, str], None])` - callback(public_key, status)
         - `get_user_status() -> UserStatus` - Load from settings, default ONLINE
         - `set_user_status(status: UserStatus) -> None` - Save to settings
         - `update_contact_presence(public_key: str, status: str) -> None`
           - Update contact's online_status in database
           - Call on_status_change callback to notify UI
         - `get_contacts_presence() -> dict[str, str]` - Returns {public_key: status} for all contacts
         - `build_status_message() -> dict` - Create presence message for signaling:
           ```python
           {
               "type": "status_update",
               "status": self.get_user_status().value
           }
           ```

    2. **Update src/network/__init__.py** - Export presence classes:
       - Add PresenceManager, UserStatus exports

    Note:
    - Use asyncio.to_thread() when updating database from async context (prevents blocking)
    - Thread-safe: may be called from WebSocket thread or main thread
  </action>
  <verify>
    - `python -c "from src.network import PresenceManager, UserStatus; pm = PresenceManager(lambda pk, s: None); print(pm.get_user_status())"`
    - Should print "UserStatus.ONLINE" or similar
  </verify>
  <done>
    PresenceManager handles user status and contact presence updates
  </done>
</task>

</tasks>

<verification>
1. Settings storage works:
   ```bash
   python -c "from src.storage.settings import set_setting, get_setting, Settings; set_setting(Settings.USER_STATUS, 'away'); print(get_setting(Settings.USER_STATUS))"
   ```
   Should print "away"

2. Contact online status updates:
   ```bash
   python -c "from src.storage.contacts import update_contact_online_status; print('Function exists')"
   ```

3. Presence manager initializes:
   ```bash
   python -c "from src.network.presence import PresenceManager, UserStatus; pm = PresenceManager(lambda pk, s: None); pm.set_user_status(UserStatus.BUSY); print(pm.get_user_status())"
   ```
</verification>

<success_criteria>
- Settings key-value storage works with persistence
- Contacts have online_status field
- PresenceManager tracks user status and contact presence
- All database changes work with existing SQLCipher setup
</success_criteria>

<output>
After completion, create `.planning/phases/02-signaling-infrastructure--presence/02-02-SUMMARY.md`
</output>
