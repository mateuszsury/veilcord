---
phase: 01-cryptographic-foundation-packaging
plan: 07
type: execute
wave: 5
depends_on: ["01-06"]
files_modified:
  - build.spec
  - assets/icon.ico
autonomous: false

must_haves:
  truths:
    - "PyInstaller builds .exe without errors"
    - "Built .exe starts within 5 seconds"
    - "All PyWebView and crypto imports work in packaged app"
    - "User can test full identity and contact workflow"
  artifacts:
    - path: "build.spec"
      provides: "PyInstaller build configuration"
      contains: "hiddenimports"
    - path: "dist/DiscordOpus/DiscordOpus.exe"
      provides: "Packaged application"
  key_links:
    - from: "build.spec"
      to: "frontend/dist"
      via: "datas includes React build"
      pattern: "frontend/dist.*frontend/dist"
    - from: "dist/DiscordOpus/DiscordOpus.exe"
      to: "PyWebView + SQLCipher"
      via: "hiddenimports in spec"
      pattern: "webview|sqlcipher"
---

<objective>
Package application with PyInstaller and verify complete Phase 1 functionality.

Purpose: Create the distributable .exe file that users will download. This validates that all dependencies are correctly bundled and the app works outside of the development environment. Early packaging validation (Phase 1) catches bundling issues before they become expensive to fix.

Output: Working DiscordOpus.exe with full Phase 1 functionality.
</objective>

<execution_context>
@C:\Users\thete\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thete\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cryptographic-foundation-packaging/01-RESEARCH.md
@.planning/phases/01-cryptographic-foundation-packaging/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PyInstaller Spec File</name>
  <files>
    build.spec
    assets/icon.ico
  </files>
  <action>
Create PyInstaller specification file with all hidden imports:

1. Create `assets/` directory if not exists

2. Create placeholder `assets/icon.ico`:
   - For now, create a minimal ICO file or copy a placeholder
   - Can be replaced with actual icon later
   - Use a simple script or download a placeholder

3. Create `build.spec`:
```python
# -*- mode: python ; coding: utf-8 -*-
"""
PyInstaller spec file for DiscordOpus.

IMPORTANT: Use --onedir mode (not --onefile) for faster startup.
--onefile unpacks to temp directory on every launch, adding 3-5 seconds.

Build command:
    pyinstaller build.spec

Output:
    dist/DiscordOpus/DiscordOpus.exe
"""

import sys
from pathlib import Path

# Get absolute path to project root
project_root = Path(SPECPATH).resolve()

block_cipher = None

a = Analysis(
    [str(project_root / 'src' / 'main.py')],
    pathex=[str(project_root)],
    binaries=[],
    datas=[
        # Include React frontend build
        (str(project_root / 'frontend' / 'dist'), 'frontend/dist'),
    ],
    hiddenimports=[
        # Windows APIs
        'win32crypt',
        'win32api',
        'pywintypes',
        'win32timezone',

        # SQLCipher
        'sqlcipher3',
        'sqlcipher3.dbapi2',

        # PyWebView backends
        'webview',
        'webview.platforms.edgechromium',
        'webview.platforms.winforms',

        # Cryptography internals
        'cryptography',
        'cryptography.hazmat.primitives.asymmetric.ed25519',
        'cryptography.hazmat.primitives.asymmetric.x25519',
        'cryptography.hazmat.primitives.ciphers.aead',
        'cryptography.hazmat.backends.openssl',

        # Argon2
        'argon2',
        'argon2.low_level',
        'argon2._ffi',

        # Our modules
        'src',
        'src.main',
        'src.api',
        'src.api.bridge',
        'src.crypto',
        'src.crypto.identity',
        'src.crypto.fingerprint',
        'src.crypto.backup',
        'src.storage',
        'src.storage.paths',
        'src.storage.dpapi',
        'src.storage.db',
        'src.storage.identity_store',
        'src.storage.contacts',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[
        # Exclude test frameworks
        'pytest',
        'unittest',
        # Exclude development tools
        'pip',
        'setuptools',
    ],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    [],
    exclude_binaries=True,  # Use --onedir mode
    name='DiscordOpus',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=False,  # Disable UPX to avoid antivirus false positives
    console=False,  # Windowed application (no console)
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon=str(project_root / 'assets' / 'icon.ico') if (project_root / 'assets' / 'icon.ico').exists() else None,
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=False,  # Disable UPX to avoid antivirus false positives
    upx_exclude=[],
    name='DiscordOpus',
)
```

4. Create a minimal placeholder icon or note that icon is optional

CRITICAL from research:
- Use --onedir (exclude_binaries=True), NOT --onefile
- Disable UPX (upx=False) to avoid antivirus false positives
- Include all hidden imports for win32, sqlcipher, webview, cryptography
- Console=False for windowed app
  </action>
  <verify>
    Spec file exists: `ls build.spec`
    Hidden imports present: `grep -c "hiddenimports" build.spec`
  </verify>
  <done>
    - build.spec created with all hidden imports
    - --onedir mode configured for fast startup
    - UPX disabled to avoid AV false positives
    - Frontend dist included in datas
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Application with PyInstaller</name>
  <files>
    dist/DiscordOpus/DiscordOpus.exe (generated)
  </files>
  <action>
Build the application and verify the output:

1. Ensure frontend is built:
```bash
cd frontend && npm run build
```

2. Run PyInstaller build:
```bash
pyinstaller build.spec --clean
```

3. Check build output:
```bash
ls dist/DiscordOpus/
ls dist/DiscordOpus/DiscordOpus.exe
```

4. Check for warnings in build log:
- Look for "module not found" warnings in build output
- These indicate missing hiddenimports

5. If build fails, common fixes:
- Missing module: Add to hiddenimports in build.spec
- Missing DLL: Add to binaries in build.spec
- Path issues: Verify frontend/dist exists

6. Verify the build size is reasonable (should be 50-100 MB for onedir)

NOTE: Windows Defender may flag the .exe. This is expected with PyInstaller.
See research notes on submitting false positive reports.
  </action>
  <verify>
    Exe exists: `ls dist/DiscordOpus/DiscordOpus.exe`
    Frontend bundled: `ls dist/DiscordOpus/frontend/dist/index.html`
  </verify>
  <done>
    - PyInstaller build completes without errors
    - dist/DiscordOpus/ directory created
    - DiscordOpus.exe is present
    - frontend/dist is bundled in the output
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1: Cryptographic Foundation and Packaging

    The packaged DiscordOpus.exe with:
    - Cryptographic identity generation (Ed25519/X25519)
    - Secure key storage (DPAPI + SQLCipher)
    - Key backup/restore (Argon2id + ChaCha20Poly1305)
    - Dark cosmic UI with sidebar and settings
    - Contact management
  </what-built>
  <how-to-verify>
    1. Run the packaged application:
       - Navigate to dist/DiscordOpus/
       - Double-click DiscordOpus.exe
       - App should start within 5 seconds (not counting first-run antivirus scan)

    2. Test identity generation:
       - Click "Settings" in the sidebar
       - If no identity exists, click "Generate Identity"
       - Verify you see your public key and fingerprint

    3. Test display name:
       - Click "Edit" next to your display name
       - Change it to something like "Test User"
       - Click Save
       - Close and reopen the app - name should persist

    4. Test key backup:
       - In Settings > Key Backup, enter a password
       - Click Export
       - Save the backup file
       - Note: Keep this file for import testing

    5. Test contact management:
       - In Settings > Contacts, enter:
         - Public key: 0000000000000000000000000000000000000000000000000000000000000000 (64 zeros for test)
         - Display name: Test Contact
       - Click Add Contact
       - Verify contact appears in sidebar
       - Click "Verify" on the contact to see fingerprint
       - Try "Mark as Verified" toggle

    6. Test backup restore (optional, destructive):
       - Delete %APPDATA%/DiscordOpus/ folder
       - Restart the app
       - In Settings > Key Backup, enter the password
       - Click Import and select your backup file
       - Verify your identity is restored

    Expected results:
    - App starts in <5 seconds
    - Dark cosmic theme with starry background
    - All identity operations work
    - Contacts persist in sidebar
    - Backup export creates valid JSON file
    - No crashes or error popups
  </how-to-verify>
  <resume-signal>
    Type "approved" if all tests pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. PyInstaller builds without errors
2. dist/DiscordOpus/DiscordOpus.exe exists
3. App starts within 5 seconds
4. All Phase 1 features work in packaged app
5. User verification confirms functionality
</verification>

<success_criteria>
Phase 1 complete when:
- [x] build.spec has all hidden imports
- [x] PyInstaller build succeeds
- [x] .exe starts in <5 seconds
- [x] Identity generation works
- [x] Display name persists across restarts
- [x] Key backup export creates valid file
- [x] Key backup import restores identity
- [x] Contact add/remove works
- [x] Contact verification works
- [x] Dark cosmic theme displays correctly
- [x] User approves functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-cryptographic-foundation-packaging/01-07-SUMMARY.md`
</output>
